# js 中的 number 为何很怪异

> 声明：需要读者对二进制有一定的了解

对于 JavaScript 开发者来说，或多或少都遇到过 `js` 在处理数字上的奇怪现象，比如：

```
> 0.1 + 0.2
0.30000000000000004

> 0.1 + 1 - 1
0.10000000000000009

> 0.1 * 0.2
0.020000000000000004

> Math.pow(2, 53)
9007199254740992

> Math.pow(2, 53) + 1
9007199254740992

> Math.pow(2, 53) + 3
9007199254740996
```

如果想要弄明白为什么会出现这些奇怪现象，首先要弄清楚 *JavaScript 是怎样编码数字的*。

## 1. JavaScript 是怎样编码数字的

JavaScript 中的数字，不管是整数、小数、分数，还是正数、负数，全部是浮点数，都是用 4 个字节（64 位）来存储的。

一个数字（如 `12`、`0.12`、`-999`）在内存中占用 4 个字节（64 位），存储方式如下：

1. `0 - 51`：分数部分（52 位）
2. `52 - 62`：指数部分（11 位）
3. `63`：符号位（1 位：0 表示这个数是正数，1 表示这个数是负数）

符号位很好理解，用于指明是正数还是负数，且只有 1 位、两种情况（0 表示正数，1 表示负数）。

其他两部分是分数部分和指数部分，用于计算一个数的绝对值。

### 1.1 绝对值计算公式

```
1: abs = 1.f * 2 ^ (e - 1023)             0 < e < 2047
2: abs = 0.f * 2 ^ (e - 1022)             e = 0, f > 0
3: abs = 0                                e = 0, f = 0
4: abs = NaN                              e = 2047, f > 0
5: abs = ∞ (infinity, 无穷大)              e = 2047, f = 0
```

说明：

- 公式是二进制的算法公式，结果用 `abs` 表示，分数部分用 `f` 表示，指数部分用 `e` 表示（另外，后面会用 `s` 表示符号位）
- `2 ^ (e - 1023)` 表示 `2` 的 `e - 1023` 次方
- 因为分数部分占 52 位，所以 `f` 的取值范围为 `00...00`（中间省略 48 个 0） 到 `11...11`（中间省略 48 个 1）
- 因为指数部分占 11 位，所以 `e` 的取值范围为 `0`（`00000000000`） 到 `2047`（`11111111111`）

从上面的公式可以看出：

- `1` 的存储方式：`1.00 * 2 ^ (1023 - 1023)`（`f = 0000..., e = 1023`，`...` 表示 48 个 0）
- `2` 的存储方式：`1.00 * 2 ^ (1024 - 1023)`（`f = 0000..., e = 1024`，`...` 表示 48 个 0）
- `9` 的存储方式：`1.01 * 2 ^ (1025 - 1023)`（`f = 0100..., e = 1025`，`...` 表示 48 个 0）
- `0.5` 的存储方式：`1.00 * 2 ^ (1022 - 1023)`（`f = 0000..., e = 1022`，`...` 表示 48 个 0）
- `0.625` 的存储方式：`1.01 * 2 ^ (1021 - 1023)`（`f = 0100..., e = 1021`，`...` 表示 48 个 0）
  
### 1.2 绝对值的取值范围与边界

从上面的公式可以看出：

##### `0 < e < 2047`

当 `0 < e < 2047` 时，取值范围为：`f = 0, e = 1` 到 `f = 11...11, e = 2046`（中间省略 48 个 1）

即：`Math.pow(2, -1022)` 到 `~= Math.pow(2, 1024) - 1`（`～=` 表示约等于）

这当中，`~= Math.pow(2, 1024) - 1` 就是 `Number.MAX_VALUE` 的值。

##### `e = 0, f > 0`

当 `e = 0, f > 0` 时，取值范围为：`f = 00...01, e = 0`（中间省略 48 个 0） 到 `f = 11...11, e = 0`（中间省略 48 个 1）

即：`Math.pow(2, -1074)` 到 `~= Math.pow(2, -1022)`（`～=` 表示约等于）

这当中，`Math.pow(2, -1074)` 就是 `Number.MIN_VALUE` 的值。

##### `e = 0, f = 0`

这只表示一个值 `0`，但加上符号位，所以有 `+0` 与 `-0`。

但在运算中：

```
> +0 === -0
true
```

##### `e = 2047, f > 0`

这只表示一种值 `NaN`。

但在运算中：

```
> NaN == NaN
false

> NaN === NaN
false
```

##### `e = 2047, f = 0`

这只表示一个值 `∞` (infinity, 无穷大)。

在运算中：

```
> Infinity === Infinity
true

> -Infinity === -Infinity
true
```

### 1.3 绝对值的最大安全值

从上面可以看出，4 个字节能存储的最大数值是 `Number.MAX_VALUE` 的值，也就是 `~= Math.pow(2, 1024) - 1`。

但这个数值并不安全：从 `1` 到 `Number.MAX_VALUE` 中间的数字并不连续，而是离散的。

比如：`Number.MAX_VALUE - 1`, `Number.MAX_VALUE - 2` 等数值都无法用公式得出，就存储不了。

所以这里引出了最大安全值 `Number.MAX_SAFE_INTEGER`，也就是从 `1` 到 `Number.MAX_SAFE_INTEGER` 中间的数字都是连续的，处在这个范围内的数值计算都是安全的。

当 `f = 11...11, e = 1075`（中间省略 48 个 1）时，取得这个值 `111...11`（中间省略 48 个 1），即 `Math.pow(2, 53) - 1`。

大于 `Number.MAX_SAFE_INTEGER：Math.pow(2, 53) - 1` 的数值都是离散的。

比如：`Math.pow(2, 53) + 1`, `Math.pow(2, 53) + 3` 不能用公式得出，无法存储在内存中。

所以才会有文章开头的现象：

```
> Math.pow(2, 53)
9007199254740992

> Math.pow(2, 53) + 1
9007199254740992

> Math.pow(2, 53) + 3
9007199254740996
```

因为 `Math.pow(2, 53) + 1` 不能用公式得出，就无法存储在内存中，所以只有取最靠近这个数的、能够用公式得出的其他数，`Math.pow(2, 53)`，然后存储在内存中，这就是失真，即不安全。

### 1.4 分数的存储方式与计算



## 2. Number 对象中的常量

### 2.1 Number.EPSILON

```
Math.pow(2, -52)
```

### 2.2 Number.MAX_SAFE_INTEGER

```
Math.pow(2, 53) - 1
```

### 2.3 Number.MAX_VALUE

```
~= Math.pow(2, 1024) - 1
```

### 2.4 Number.MIN_SAFE_INTEGER

```
-(Math.pow(2, 53) - 1)
```

### 2.5 Number.MIN_VALUE

```
Math.pow(2, -1074)
```

### 2.6 Number.NEGATIVE_INFINITY
### 2.6 Number.POSITIVE_INFINITY
### 2.6 Number.NaN

## 参考文章

- [How numbers are encoded in JavaScript](http://2ality.com/2012/04/number-encoding.html)
- [JavaScript是怎样编码数字的](https://segmentfault.com/a/1190000017090272)

## 后续

更多博客，查看 [https://github.com/senntyou/blogs](https://github.com/senntyou/blogs)

作者：[深予之 (@senntyou)](https://github.com/senntyou)

版权声明：自由转载-非商用-非衍生-保持署名（[创意共享3.0许可证](https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh)）
